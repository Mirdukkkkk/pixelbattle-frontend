var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{d as i,A as s,x as n,y as o,u as a}from"./preact-DoPIZWeU.js";import{c as r,P as h,a as l,C as c,O as d,N as u,b as p,d as v,e as w,I as m,f,g as b,A as g,h as x}from"./main-uIeNFnwV.js";import{T as y,b as P,F as k,c as E,d as C,S as L,e as M,P as I,A as R,E as S,h as z}from"./render-D473Hyb3.js";import{S as W}from"./snapshot-CQjLHgud.js";const A=y.fromBuffer(new Uint8Array([255,255,255]),1,1,{alphaMode:P.NO_PREMULTIPLIED_ALPHA,format:k.RGB,scaleMode:E.NEAREST});function O(e,t){return Math.random()*(t-e)+e}class H extends C{constructor(){super(),t(this,"border"),t(this,"background"),t(this,"isShaking",!1),this.border=new L(A),this.background=new L(A),this.setup()}startShake(){const e=this.position.clone(),t=Date.now(),i=s=>{if(this.position.x=e.x+O(-r.shakeAmount,r.shakeAmount),this.position.y=e.y+O(-r.shakeAmount,r.shakeAmount),this.isShaking=!0,Date.now()-t>r.time.shake)return this.position.x=e.x,this.position.y=e.y,void(this.isShaking=!1);requestAnimationFrame(i)};i()}setup(){this.border.anchor.set(.5,.5),this.background.anchor.set(.5,.5),this.border.scale.set(1+r.hover.outlineSize),this.eventMode="none",this.visible=!1,this.zIndex=9999,this.addChild(this.border,this.background)}hover(e){if(this.visible=!0,this.isShaking)return;if(this.position.set(e.x+.5,e.y+.5),this.scale.set(r.hover.scale),null===h.image.value)return;const t=l.palette.value.selected;this.background.tint=t,this.border.tint=t.getReadableColor()}out(){this.visible=!1,this.scale.set(1)}}class _ extends L{constructor(){super(),t(this,"isZommed",!1),t(this,"isDragged",!1),this.setup()}get image(){if(null===h.image.value)throw new Error("Can't find image");return h.image.value}get size(){if(null===h.image.value)throw new Error("Can't find image");return h.image.value.size}setup(){this.eventMode="static",this.texture=y.fromBuffer(this.image.buffer,this.size.x,this.size.y,{resolution:1,format:k.RGB,type:M.UNSIGNED_BYTE,alphaMode:P.NO_PREMULTIPLIED_ALPHA,scaleMode:E.NEAREST}),this.on("pointermove",this.onPointerMove.bind(this)),this.on("pointerout",this.onPointerOut.bind(this))}async onClick(e,t){const i=this.image.getPixel(e);return 0===t?c.isEnabled.value?this.emit("will-color-pick",i):this.emit("will-place",e):2===t?this.emit("will-color-pick",i):void 0}onPointerMove(e){const t=e.getLocalPosition(this),{x:i,y:s}=this.image.size;if(t.x<0||t.x>i||t.y<0||t.y>s)return;const n=new I(Math.floor(t.x),Math.floor(t.y));this.emit("hover",n)}onPointerOut(e){this.emit("out")}setSquare(e,t){this.image.setPixel(e,t),this.texture.update(),this.emit("place",{point:e,color:t})}}class D extends L{constructor(){super(),this.setup()}setup(){this.eventMode="static",this.hitArea={contains:()=>!1},d.opacity.subscribe((e=>e&&(this.alpha=e/100))),d.position.subscribe((e=>{e&&(this.position=e)})),d.image.subscribe((e=>e?this.show():this.hide()))}hide(){this.visible=!1,this.texture=A}show(){this.visible=!0,this.texture=y.fromBuffer(d.image.value.buffer,d.image.value.size.x,d.image.value.size.y,{format:k.RGBA,alphaMode:P.NO_PREMULTIPLIED_ALPHA,scaleMode:E.NEAREST})}}class N extends L{constructor(){super(),this.setup()}setup(){this.texture=A,this.visible=!1,this.alpha=.5,W.enable.subscribe((e=>this.visible=!0)),W.offsetPoint.subscribe((e=>{this.x=e.x,this.y=e.y;const t=W.startPoint.value;0===this.x&&(this.x=t.x),0===this.y&&(this.y=t.y)})),W.startPoint.subscribe((e=>{const t=W.offsetPoint.value;this.x=e.x-t.x,this.y=e.y-t.y;const i=h.image.value;i&&(this.tint=i.getPixel(e).getReadableColor())})),W.size.subscribe((e=>{this.width=Math.abs(e.x),this.height=Math.abs(e.y)}))}}class T extends C{constructor(e,i){super(),t(this,"pointer",new H),t(this,"place",new _),t(this,"overlay",new D),t(this,"snapshot",new N),t(this,"pixelInfo",{lastPoint:new I(-1,-1),lastPointTimeout:-1,timeoutId:-1}),this.viewport=e,this.canvasRef=i,this.setup()}onClick(e){const t=e.event,i=t.getLocalPosition(this),s=new I(Math.floor(i.x),Math.floor(i.y)),n=h.image.value,o=d.image.value,a=d.position.value;if(null===n)return;if(s.x<0||s.x>n.size.x||s.y<0||s.y>n.size.y)return;if(W.enable.value)return void(2===t.button?W.stop():W.onPointerClick(s));if(null===a||null===o)return void this.place.onClick(s,t.button);if(!(s.x<=o.size.x+a.x&&s.x>=a.x&&s.y<=o.size.y+a.y&&s.y>=a.y))return void this.place.onClick(s,t.button);const r=s.clone().set(s.x-a.x,s.y-a.y),l=o.getPixel(r);if(0!==l.alpha)return 0===t.button?c.isEnabled.value?void this.onWillColorPick(l):this.onWillPlace(s):2===t.button?this.onWillColorPick(l):void 0;this.place.onClick(s,t.button)}setup(){this.on("cant-place",this.onCantPlace.bind(this)),this.viewport.on("drag-start",this.onDragStart.bind(this)),this.viewport.on("drag-end",this.onDragEnd.bind(this)),this.place.on("will-place",this.onWillPlace.bind(this)),this.place.on("place",this.onPlace.bind(this)),this.place.on("will-color-pick",this.onWillColorPick.bind(this)),this.place.on("hover",this.onHover.bind(this)),this.place.on("out",this.onOut.bind(this)),this.addChild(this.place),this.addChild(this.overlay),this.addChild(this.snapshot),this.addChild(this.pointer)}onDragStart(e){this.canvasRef.current&&(this.canvasRef.current.style.cursor="grabbing")}onDragEnd(e){this.canvasRef.current&&(this.canvasRef.current.style.cursor="crosshair"),this.cursor="default"}onCantPlace({reason:e}){u.addNotification({...p[e],type:"error"}),this.pointer.startShake()}onWillPlace(e){if(v.hasCooldown.peek())return this.emit("cant-place",{reason:"Cooldown"});if(null===w.profile.peek())return this.emit("cant-place",{reason:"Not logged"});if(null===m.info.value||null===h.image.value)return;if(m.info.value.ended)return this.emit("cant-place",{reason:"Game ended"});if(w.isBanned.value)return this.emit("cant-place",{reason:"Banned"});const t=h.image.value.getPixel(e);this.place.setSquare(e,l.palette.value.selected),f.putPixel({color:l.palette.value.selected.toHex(),x:e.x,y:e.y}).catch((i=>{this.place.setSquare(e,t)}))}onPlace(e){this.pointer.hover(e),v.start()}onHover(e){b.setCoordinates(e),this.pointer.hover(e),W.captureMode.value&&W.onPointerMove(e),this.pixelInfo.lastPoint.equals(e)||(-1!==this.pixelInfo.timeoutId&&(window.clearTimeout(this.pixelInfo.timeoutId),this.pixelInfo.timeoutId=-1),b.info.value="loading",this.pixelInfo.lastPoint=e.clone(),this.pixelInfo.timeoutId=window.setTimeout((()=>{-1!==b.coordinates.value.x&&-1!==b.coordinates.value.y&&b.fetchInfo()}),r.time.pixelInfo))}update(){this.place.texture.update()}onOut(){b.removeCoordinates(),this.pointer.out()}onWillColorPick(e){c.isEnabled.value=!1,this.pointer.background.tint=e,this.pointer.border.tint=e.getReadableColor(),l.addAndSelect(e)}}class B{constructor(){t(this,"ws")}connect(){this.createWebSocket(),this.setupEventListeners()}createWebSocket(){this.ws=new WebSocket(r.url.api.replace("http","ws")+"/pixels/socket")}setupEventListeners(){this.ws.addEventListener("open",this.onOpen.bind(this)),this.ws.addEventListener("message",this.onMessage.bind(this)),this.ws.addEventListener("close",this.onClose.bind(this)),this.ws.addEventListener("error",this.onError.bind(this))}async onMessage(e){const t=e.data instanceof Blob?await new Response(e.data).json():JSON.parse(e.data);if(null!==h.image.value)switch(t.op){case"PLACE":h.image.value.setPixel(new I(t.x,t.y),new g(t.color)),h.container.value.update();break;case"ENDED":t.value?m.end():m.start()}}onOpen(e){}reconnect(){h.fetch().then((()=>h.container.value.update())).then((()=>this.connect()))}onClose(e){setTimeout(this.reconnect.bind(this),r.time.ws)}onError(e){this.onClose(new CloseEvent("close",e))}}class K{constructor(e){t(this,"app"),t(this,"viewport"),t(this,"canvasRef"),t(this,"container"),this.canvasRef=e,this.app=new R({view:e.current,width:window.innerWidth,height:window.innerHeight,backgroundColor:r.defaults.colors.background});const i=new S(this.app.renderer);i.domElement=e.current,this.viewport=new z({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:2*window.innerWidth,worldHeight:2*window.innerHeight,events:i,disableOnContextMenu:!0})}create(e){if(this.container=new T(this.viewport,this.canvasRef),null===e.image.value)return;const{size:t}=e.image.value;this.viewport.drag().pinch().wheel().fit(!0,t.x,t.y).zoomPercent(-r.zoom.defaultLevel,!0).clampZoom({minWidth:this.viewport.worldWidth/500,minHeight:this.viewport.worldHeight/500,maxWidth:5*t.x,maxHeight:5*t.y}).moveCenter(new I(t.x/2,t.y/2)).on("clicked",this.container.onClick.bind(this.container)),this.app.stage.addChild(this.viewport),this.viewport.addChild(this.container),e.container.value=this.container;(new B).connect(),window.addEventListener("resize",this.onWindowResize.bind(this))}onWindowResize(){this.app.renderer.resize(window.innerWidth,window.innerHeight),this.viewport.resize(window.innerWidth,window.innerHeight)}}const j="_canvas_2a5mv_1";const q={pipe:i(new class{constructor(){t(this,"pipeOfKeys",[]),t(this,"pipeOfListeners",[]),t(this,"storedKeyCodes",{})}sub(e,t){this.storedKeyCodes[e]=!0,this.pipeOfKeys.push(e),this.pipeOfListeners.push(t)}emit({repeat:e,code:t,type:i,ctrlKey:s}){this.storedKeyCodes[t]&&!e&&this.pipeOfKeys.forEach(((e,n,o)=>{t===e&&this.pipeOfListeners[n]({isKeyDown:"keydown"===i,ctrlKey:s})}))}}),_listener(e){q.pipe.value.emit(e)},addEventListeners(){document.addEventListener("keydown",q._listener),document.addEventListener("keyup",q._listener)},removeEventListeners(){document.removeEventListener("keydown",q._listener),document.removeEventListener("keyup",q._listener)}};function G(){const e=s(null),t=n(x);return o((function(){const i=new K(e);return t.fetch().then((()=>i.create(t))),q.addEventListeners(),()=>{q.removeEventListeners()}}),[]),a("canvas",{ref:e,className:j})}export{G as Place};
